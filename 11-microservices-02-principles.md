
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Сравнительная таблица решений

| Решение              | Маршрутизация                                     | Аутентификация                         | HTTPS терминация | Доп. возможности                                         | Лицензия / Стоимость         |
|----------------------|---------------------------------------------------|----------------------------------------|------------------|---------------------------------------------------------|------------------------------|
| **NGINX (OSS/Plus)** | Гибкая (URI, заголовки, SNI)                      | Через модули (lua, OpenResty, Plus JWT)| Да               | Rate limiting, кэш, балансировка                        | OSS (бесплатно) / Plus (платно) |
| **Kong Gateway**     | Да (NGINX + Lua)                                  | JWT, OAuth2, OIDC (встроенные плагины) | Да               | Большая экосистема плагинов, observability              | OSS (бесплатно) / Enterprise (платно) |
| **Traefik**          | Динамическая, auto-discovery (Docker/K8s)         | Middleware (JWT, OIDC, BasicAuth)      | Да (ACME/LE)     | Интеграция с Docker/K8s, observability                  | OSS (бесплатно) / Enterprise (платно) |
| **HAProxy**          | Высокопроизводительная маршрутизация              | JWT через Lua                          | Да               | L4+L7 балансировка, высокая производительность          | OSS (бесплатно) / Enterprise (платно) |
| **AWS API Gateway**  | Path, header, stage                               | Cognito, IAM, OAuth2                   | Да               | Rate limiting, WAF, monitoring (CloudWatch)             | Платный сервис (pay-as-you-go) |
| **Azure API Mgmt**   | Да                                                | OAuth2, JWT (политики)                 | Да               | Developer portal, rate limiting, трансформация ответов  | Платный сервис |
| **Istio (Service Mesh)** | Через Envoy sidecar                          | JWT, OIDC                              | Да               | Полный сервис-меш: observability, security, traffic mgmt| OSS, но сложный в эксплуатации |

---

## Выбор решения

- Для **контейнерной среды (Kubernetes/Docker)** → **Traefik** (удобная динамика).  
- Для **богатой аутентификации и расширяемости** → **Kong Gateway**.  
- Для **облачной инфраструктуры (AWS/Azure/GCP)** → использовать Managed API Gateway.  
- Для **максимальной производительности при простоте** → **NGINX/HAProxy**.  

---

## Обоснованный выбор

Для решения задач:
- маршрутизация по конфигурации,  
- проверка аутентификационных данных (JWT),  
- терминация HTTPS,  

наиболее оптимален **Kong Gateway (Community Edition)**:  
- встроенные плагины для JWT/OIDC,  
- основан на NGINX (надёжный и быстрый),  
- бесплатная версия покрывает все базовые требования,  
- легко интегрируется с мониторингом (Prometheus, Grafana).  



## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.



## Требования
- Поддержка кластеризации для надёжности  
- Хранение сообщений на диске в процессе доставки (durability)  
- Высокая производительность  
- Поддержка различных форматов сообщений (JSON, Avro, Protobuf и др.)  
- Разделение прав доступа (ACL, RBAC)  
- Простота эксплуатации  

---

## Сравнительная таблица решений

| Решение              | Кластеризация | Хранение на диске | Производительность | Поддержка форматов сообщений | Управление доступом | Простота эксплуатации | Лицензия / Стоимость |
|----------------------|---------------|------------------|-------------------|------------------------------|---------------------|-----------------------|----------------------|
| **RabbitMQ**         | Да (кластер/федерация) | Да (durable queues) | Средняя (до ~100k msg/s) | Любые (текст/бинарные, через AMQP) | Да (vhosts, users, permissions) | Простая установка, UI | OSS (бесплатно) |
| **Apache Kafka**     | Да (Kafka Cluster, ZooKeeper/KRaft) | Да (commit log) | Очень высокая (>1M msg/s) | Avro, JSON, Protobuf, любые байтовые данные | ACL, SASL, Kerberos | Сложнее в эксплуатации, требует DevOps | OSS (бесплатно), Confluent (платно) |
| **ActiveMQ (Classic/Artemis)** | Да (cluster, master/slave, network of brokers) | Да | Средняя | AMQP, JMS, MQTT, OpenWire | Да (users, groups, ACL) | Средняя сложность | OSS (бесплатно) |
| **NATS**             | Да (JetStream clustering) | Да (JetStream persistence) | Очень высокая (низкая латентность, ~Млн msg/s) | JSON, Protobuf, любые байты | JWT, NKey, Accounts | Очень простая установка, лёгкий бинарник | OSS (бесплатно), NATS JetStream OSS |
| **Redis Streams**    | Да (Redis Cluster, Sentinel) | Да (в памяти + AOF persistence) | Высокая (но медленнее Kafka при больших потоках) | JSON, MsgPack, любые байты | ACL с Redis 6+ | Очень простая эксплуатация | OSS (бесплатно) |
| **AWS SQS / Google PubSub / Azure Service Bus** | Обеспечивается облаком | Да | Высокая | JSON, текст, любые байты | IAM/ролевая модель | Максимально простая эксплуатация (managed) | Платные облачные сервисы |

---

## Выбор решения

- **RabbitMQ** — хорошо подходит для классического messaging (очереди задач, RPC, интеграции сервисов), прост в эксплуатации.  
- **Kafka** — оптимален для систем, где важен потоковый анализ, огромный объём сообщений и высокая пропускная способность.  
- **ActiveMQ** — традиционное JMS-решение, но обычно проигрывает RabbitMQ и Kafka в производительности и популярности.  
- **NATS** — современный лёгкий брокер, отличная производительность и простота, но меньше зрелых enterprise-функций, чем у Kafka.  
- **Redis Streams** — хорош для простых очередей, но не заменяет полноценный брокер сообщений.  
- **Облачные сервисы (SQS, PubSub, Service Bus)** — лучший выбор, если инфраструктура полностью в облаке и важна минимальная поддержка.  

---

## Обоснованный выбор

С учётом требований:
- кластеризация,  
- хранение сообщений на диске,  
- высокая скорость работы,  
- поддержка разных форматов,  
- ACL,  
- простота эксплуатации,  

наиболее сбалансированным выбором является **RabbitMQ**:  
- Поддерживает отказоустойчивые кластеры, федерацию и зеркалирование очередей.  
- Хранит сообщения на диске (durable + persistent messages).  
- Прост в эксплуатации (удобная админка, много документации, лёгкая интеграция).  
- Гибкая модель доступа (vhost, users, permissions).  
- Поддерживает любые форматы сообщений (бинарные/текстовые).  

Если же приоритет — **огромная нагрузка (миллионы сообщений в секунду)** и потоковая аналитика → лучше **Kafka**.  

---

✅ **Вывод:**  
- Для большинства enterprise-систем и микросервисной архитектуры оптимален **RabbitMQ** (баланс функционала и простоты).  
- Для Big Data / потоковой обработки — **Apache Kafka**.  






## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
